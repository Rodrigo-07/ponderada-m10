# dá FDs suficientes ao processo (precisa ser ≥ worker_connections)
worker_rlimit_nofile  8192;

worker_processes 1;
events {
    # até 4096 sockets simultâneos no ÚNICO worker
    worker_connections 4096;
    # opcional: deixa o worker aceitar vários sockets de uma vez
    multi_accept on;
}

http {
    # buffers enxutos para não explodir a RAM
    proxy_buffers           4 4k;
    proxy_buffer_size       2k;
    proxy_busy_buffers_size 4k;
    proxy_max_temp_file_size 0;

    # upstream mantém no máximo 16 sockets abertos com cada API
    upstream api {
        keepalive 128;             # antes: 32
        server api01:8080;
        server api02:8080;
    }

    keepalive_timeout 15s;        # já configurado
    keepalive_requests 5000;

    server {
        listen 9999;
        location / {
            proxy_http_version 1.1;
            proxy_set_header Connection close;
            proxy_pass http://api;
        }
    }
}
